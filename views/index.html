<!DOCTYPE html>
<html>
<head>
<style>

@font-face {
  font-family: Museo;
  src: url('static/Museo_Slab_500.otf') format('opentype');
}

.radial {
  /* fallback */
  background-color: #1F1717;

  /* Safari 4-5, Chrome 1-9 */
  background: -webkit-gradient(radial, 50% 50%, 0, 50% 50%, 100, from(#1F1717), to(#444444));

  /* Safari 5.1+, Chrome 10+ */
  background: -webkit-radial-gradient(50% 50%, closest-corner, #1F1717, #444444);

  /* Firefox 3.6+ */
  background: -moz-radial-gradient(50% 50%, closest-corner, #1F1717, #444444);

  /* IE 10 */
  background: -ms-radial-gradient(50% 50%, closest-corner, #1F1717, #444444);

  /* Opera cannot do radial gradients yet */
}

body {
  font-family: Museo, Gill Sans;
}

a {
  color: #F8DF90;
  text-decoration: none;
}

a:hover {
  color: <%= light %>;
}

#main_column {
  margin: 2em auto;
  width: 80%;
}

#container {
  display: inline-block;
  position: relative;
  width: 100%;
  min-width:320px; // iPhone
}

#dummy {
  padding-top: <%= height %>%;
}

#grid {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
}

@keyframes light {
  from { background-color: <%= dim %>; }
  to { background-color: <%= light %>; }
}

/* Safari and Chrome */
@-webkit-keyframes light {
  from { background-color: <%= dim %>; }
  to { background-color: <%= light %>; }
}

@keyframes dim {
  from { background-color: <%= light %>; }
  to { background-color: <%= dim %>; }
}

/* Safari and Chrome */
@-webkit-keyframes dim {
  from { background-color: <%= light %>; }
  to { background-color: <%= dim %>; }
}

.bulb {
  position: absolute;
  border-radius: 50%;
  width: <%= w %>%;
  height: <%= h %>%;
  background-color: <%= dim %>;
  float:left;
}

.bulb:hover {
  background-color: #888888;
}

.lit {
  animation: light .25s;  
  -webkit-animation: light .25s;  
  background-color: #FFD649;
}

.lit:hover {
  background-color: #F8DF90;
}

.dim {
  animation: dim .25s;
  -webkit-animation: dim .25s;
}

.first {
  margin-left: 0%;
}

v.first_odd {
  margin-left: <%= (d_n + w) / 2%>%;
}

.attribution {
  text-align: center;
  font-size: .7em;
  color: #888888;
  border-style: solid;
  border-width: 2px 0 0 0;
  border-color: #555555;
  padding: 1em 0;
}

</style>

<script src="/socket.io/socket.io.js"></script>
<script src="/static/fn.js"></script>
<script>

  var initial_state = [<%= initial_state %>];
  var state = [];
  for (var i = 0; i < initial_state.length; i++) {
    state.push(0);
  }
  var base = 32;

  var url = window.location.protocol + "//" + window.location.host;
  var socket = io.connect(url);
  socket.on('pixelwall_update', function (data) {
    setState(data);
  });

  function tap(e) {
    var lit = e.classList.contains('lit');
    var id = e.id.substring(5);

    var index = Math.floor (id / base);
    var val = 1 << parseInt(id % base);
    var filler = 0;
    if (lit) {
      val = ~val;
      filler = ~0;
      e.classList.remove('lit');
      e.classList.add('dim');
    } else {
      e.classList.add('lit');
      e.classList.remove('dim');
    }    
    
    var delta = [];
    for (var i = 0; i < state.length; i++) {
      delta.push(filler);
    }
    delta[index] = val;
    socket.emit('pixelwall_tap', delta);
  }                  

  function setState(new_state) {
    var mask = map(new_state, state, function (a, b) { return  a ^ b; });
    var new_list_arr = map(new_state, mask, function (a, b) { return a & b; });
    var new_dim_arr = map(new_state, mask, function (a, b) { return ~a & b; });

    var new_lit, new_dime, id, i = 0;
    var lit = false;
    for (var n = 0; n < state.length; n++) {
      new_lit = new_list_arr[n] >>> 0;
      new_dim = new_dim_arr[n] >>> 0;                  
      i = 0;
      while (new_lit > 0 || new_dim > 0) {
        id = n * base + i;
        lit = new_lit & 1 == 1;      
        dim = new_dim & 1 == 1;
        if (lit) {
         var el = document.getElementById('bulb_' + id);
         el.classList.add('lit');
         el.classList.remove('dim');
        } else if (dim) {
         var el = document.getElementById('bulb_' + id);
         el.classList.add('dim');
         el.classList.remove('lit');
        }

        i++;      
        new_lit = new_lit >>> 1;
        new_dim = new_dim >>> 1;
      }
    }

    state = new_state;
  }
  

</script>

</head>
<body class="radial">

</div>
<div id="main_column">
  <div id="container">
    <div id="dummy"></div>
    <div id="grid">
      <% for(var i=0; i< m; i++) {%>
           <% for(var j=0; j < n - (i % 2); j++) {%>
              <div id="bulb_<%= n * i + j - (i - i % 2)/ 2%>" 
                   class="bulb<% if (j == 0) {%> first<% }  %><% if (j == 0 && (i % 2) == 1) {%> first_odd<% } %>" 
                   style="top:<%= d_m * i%>%; left:<%= d_n * j + (((i % 2) == 1) ? (d_n / 2) : 0)%>%"
                   onclick="tap(this);" >
              </div>
              <% } %>
         <% } %>
    </div>
  </div>
</div>


<div class="attribution"> 
  Inspired by the<a href="http://www.purincess.com/experiments/tap-tap-animation/"> Tap Tap Animation</a> art installation from Purin Phanichphant
  <br />
  Source on <a href="https://github.com/albertlai/pixelwall">github</a> 
</div>

</body>

</html>
