<!DOCTYPE html>
<html>
<head>
<style>

body {
  font-family: Roboto;
}

h2 {
  text-align: center;
  font-size: 3em;
  color: #777777;
}

#main_column {
  margin-left: auto;
  margin-right: auto;
  width: 80%;
}

#container {
  display: inline-block;
  position: relative;
  width: 100%;
  min-width:500px;
}

#dummy {
  padding-top: 100%%;
}

#grid {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
}

.bulb {
  position: absolute;
  border-radius: 50%;
  width: <%= diameter %>%;
  height: <%= diameter %>%;
//  margin-left: <%= d_n %>%;
  background-color: #EEEEEE;
  float:left;
}

.bulb:hover {
  background-color: #CCCCCC;
}

.lit {
  background-color: #FFD649;
}

.lit:hover {
  background-color: #F8DF90;
}

.first {
  margin-left: 0%;
}

.first_odd {
  margin-left: <%= (d_n + diameter) / 2%>%;
}

</style>

<script src="/socket.io/socket.io.js"></script>
<script>

  var initial_state = [<%= initial_state %>];
  var state = [];
  for (var i = 0; i < initial_state.length; i++) {
    state.push(0);
  }
  var base = 32;

  var socket = io.connect('http://localhost:8080');
  socket.on('update', function (data) {
    setState(data);
  });

  function map(arr1, arr2, fn) {
    var result = new Array(arr1.length);
    for (var i = 0; i < arr1.length; i++) {
      result[i] = fn(arr1[i], arr2[i]);
    }
    return result;
  }

  function tap(e) {
    var lit = e.classList.contains('lit');
    var id = e.id.substring(5);

    console.log("tap " + lit);
    var index = Math.floor (id / base);
    var val = 1 << parseInt(id % base);
    var filler = 0;
    if (lit) {
      val = ~val;
      filler = ~0;
      e.classList.remove('lit');
    } else {
      e.classList.add('lit');
    }    
    
    var delta = [];
    for (var i = 0; i < state.length; i++) {
      delta.push(filler);
    }
    delta[index] = val;

    socket.emit('tap', delta);
  }                  

  function setState(new_state) {
    console.log(new_state.length);
    var mask = map(new_state, state, function (a, b) { return  a ^ b; });
    var new_list_arr = map(new_state, mask, function (a, b) { return a & b; });
    var new_dim_arr = map(new_state, mask, function (a, b) { return ~a & b; });

    var new_lit, new_dime, id, i = 0;
    var lit = false;
    for (var n = 0; n < state.length; n++) {
      new_lit = new_list_arr[n];
      new_dim = new_dim_arr[n];                  
      i = 0;
      while (new_lit > 0 || new_dim > 0) {
        id = n * base + i;
        lit = new_lit & 1 == 1;      
        dim = new_dim & 1 == 1;
        if (lit) {
         document.getElementById('bulb_' + id).classList.add('lit');
        } else if (dim) {
         document.getElementById('bulb_' + id).classList.remove('lit');
        }

        i++;      
        new_lit = new_lit >> 1;
        new_dim = new_dim >> 1;
      }
    }

    state = new_state;
  }
  

</script>

</head>
<body>
  <h2> HELLO </h2>

<div id="main_column">
  <div id="container">
    <div id="dummy"></div>
    <div id="grid">
      <% for(var i=0; i< m; i++) {%>
           <% for(var j=0; j < n - (i % 2); j++) {%>
              <div class="bulb<% if (j == 0) {%> first<% }  %><% if (j == 0 && (i % 2) == 1) {%> first_odd<% } %>" id="bulb_<%= n * i + j - (i - i % 2)/ 2%>" onclick="tap(this);"  style="margin-top:<%= d_m * i%>%; margin-left:<%= d_n * j + (((i % 2) == 1) ? (d_n / 2) : 0)%>%" > 
              </div>
              <% } %>
         <% } %>
    </div>
  </div>
</div>

<script>

setState(initial_state);

</script>

</body>

</html>
